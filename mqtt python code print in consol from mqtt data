import paho.mqtt.client as mqtt
import mariadb, sys

def add_measurement_to_database(cur, t, p):
    cur.execute("INSERT INTO measurements.temperatures(temp,pos) "
                "VALUES (?,?)",(t,p))

# The callback for when the client receives a CONNACK response from the server
def on_connect(client, userdata, flags, rc):
    print("Connected with result code "+str(rc))
    client.subscribe("eaaa/e21a/test/Project3")

# The callback for when a PUBLISH message is received from the server
def on_message(client, userdata, msg):
    print(msg.topic+" "+str(msg.payload))
    add_measurement_to_database(cur, float(msg.payload), msg.topic)

# Connect to MariaDB Platform
try:
    conn = mariadb.connect(
        user="root",
        password="xxxxxxxxxxxxxxxxxxxxx",   // yours password ;)
        host="127.0.0.1",
        port=3306,
        database="measurements",
        autocommit=True
    )
except mariadb.Error as e:
    print(f"Error connecting to MariaDB Platform: {e}")
    sys.exit(1)

# Get Cursor
cur = conn.cursor()

client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message
client.connect("test.mosquitto.org")
client.loop_forever()
